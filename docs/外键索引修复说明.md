# 外键索引修复说明

## 问题描述

TypeORM 的 `synchronize: true` 在同步数据库结构时，试图删除被外键约束使用的索引，导致错误：
```
QueryFailedError: Cannot drop index 'IDX_xxx': needed in a foreign key constraint
```

## 问题原因

1. **重复索引定义**：在实体定义中，类级别和字段级别都定义了索引，导致冲突
2. **外键索引冲突**：外键约束需要索引，但 TypeORM 认为这些索引是"多余的"，试图删除它们

## 解决方案

### 1. 移除实体定义中的重复索引

已从以下实体的字段级别移除 `@Index()` 装饰器：
- `cart.entity.ts` - 移除了 `userId` 和 `productId` 字段的 `@Index()`
- `favorite.entity.ts` - 移除了 `userId` 和 `productId` 字段的 `@Index()`
- `address.entity.ts` - 移除了 `userId` 字段的 `@Index()`
- `review.entity.ts` - 移除了 `userId` 和 `productId` 字段的 `@Index()`
- `user-behavior.entity.ts` - 移除了 `userId` 和 `productId` 字段的 `@Index()`
- `notification.entity.ts` - 移除了 `userId` 字段的 `@Index()`
- `user-coupon.entity.ts` - 移除了 `userId` 和 `couponId` 字段的 `@Index()`
- `search-log.entity.ts` - 移除了 `userId` 字段的 `@Index()`

**保留的索引**：
- 类级别的复合索引（用于查询优化）
- 外键自动创建的索引（MySQL 自动管理）

### 2. 修复数据库中的外键索引

使用 `backend/scripts/fix_all_fk_indexes.js` 脚本修复了所有表的外键索引：

**修复流程**：
1. 删除外键约束
2. 删除重复的单字段索引（如果存在且不是复合索引的一部分）
3. 重新创建外键约束（MySQL 会自动创建索引，使用外键名称）

**修复结果**：
- ✅ `cart` 表：外键使用复合索引 `IDX_df04e57736b705180c89c5a636`
- ✅ `favorite` 表：外键使用复合索引 `IDX_f0e7bf803aa937033d10dc07ed`
- ✅ `review` 表：
  - `userId` 和 `productId` 使用复合索引 `IDX_711cb665a4d4f8421265d92131`
  - `orderId` 使用外键名称索引 `FK_31db76b2d6dfe81d69e27b66c20`
- ✅ `fish_product` 表：外键使用外键名称索引 `FK_442ab0f2fa5bfa37fb136b73cd5`
- ✅ `order_item` 表：外键使用外键名称索引 `FK_646bf9ece6f45dbe41c203e06e0`

### 3. 更新数据库配置

在 `backend/src/database/database.module.ts` 中：
- 添加了 `dropSchema: false` 防止删除整个 schema
- 添加了可选的 `synchronize` 禁用选项（通过环境变量 `DISABLE_SYNC=true`）

## 当前状态

所有表的外键索引都已正确配置：
- ✅ 外键使用外键名称作为索引名称（最理想，TypeORM 不会删除）
- ✅ 外键使用复合索引（也是可以的，TypeORM 知道这些索引是必需的）

## 验证脚本

使用 `backend/scripts/verify_all_indexes.js` 可以验证所有表的外键索引状态：

```bash
cd backend
node scripts/fix_all_fk_indexes.js  # 修复所有外键索引
node scripts/verify_all_indexes.js # 验证所有索引状态
```

## 注意事项

1. **不要手动添加字段级别的 `@Index()`**：对于有 `@ManyToOne` 关系的字段，TypeORM 会自动创建索引
2. **复合索引优先**：如果查询需要多个字段，使用类级别的复合索引
3. **外键索引自动管理**：MySQL 会自动为外键创建索引，使用外键名称作为索引名称

## 如果仍然遇到问题

如果 TypeORM 仍然尝试删除外键索引，可以：

1. **暂时禁用 synchronize**：
   ```bash
   # 设置环境变量
   export DISABLE_SYNC=true
   # 或 Windows PowerShell
   $env:DISABLE_SYNC="true"
   ```

2. **手动管理数据库结构**：
   - 禁用 `synchronize`
   - 使用 TypeORM migrations 管理数据库变更

3. **重新运行修复脚本**：
   ```bash
   cd backend
   node scripts/fix_all_fk_indexes.js
   ```
