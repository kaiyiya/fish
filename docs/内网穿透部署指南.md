# 内网穿透部署指南 - 本地服务器公网访问

本指南介绍如何将本地后端服务暴露到公网，用于演示和测试。

## 方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **ngrok** | 简单快速，免费版可用 | 免费版URL随机变化 | ⭐⭐⭐⭐⭐ |
| **frp** | 完全免费，可自建服务器 | 需要服务器或使用公共节点 | ⭐⭐⭐⭐ |
| **花生壳** | 国内服务，稳定 | 免费版有限制 | ⭐⭐⭐ |
| **localtunnel** | 完全免费 | 可能不稳定 | ⭐⭐⭐ |
| **钉钉内网穿透** | 免费，简单 | 仅限开发测试 | ⭐⭐ |

---

## 方案一：ngrok（推荐，最简单）

### 1. 注册和安装

**Windows系统：**

```powershell
# 方式1：下载exe文件
# 访问 https://ngrok.com/download
# 下载Windows版本，解压到任意目录

# 方式2：使用Chocolatey（如果有）
choco install ngrok

# 方式3：使用Scoop（如果有）
scoop install ngrok
```

**Mac系统：**

```bash
# 使用Homebrew
brew install ngrok/ngrok/ngrok
```

**Linux系统：**

```bash
# 下载并解压
wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
tar -xzf ngrok-v3-stable-linux-amd64.tgz
sudo mv ngrok /usr/local/bin/
```

### 2. 注册账号并获取Token

1. 访问 https://dashboard.ngrok.com/signup
2. 注册账号（可以使用GitHub账号快速注册）
3. 登录后，在 "Your Authtoken" 页面复制你的token

### 3. 配置ngrok

```powershell
# Windows PowerShell
ngrok config add-authtoken YOUR_AUTH_TOKEN

# 验证配置
ngrok config check
```

### 4. 启动后端服务

```powershell
# 确保后端服务运行在本地3000端口
cd backend
npm run start:dev
```

### 5. 启动ngrok隧道

```powershell
# 暴露本地3000端口
ngrok http 3000

# 或者指定域名（需要付费版）
ngrok http 3000 --domain=your-domain.ngrok.io
```

### 6. 获取公网地址

启动后，ngrok会显示类似以下信息：

```
Forwarding   https://xxxx-xx-xx-xx-xx.ngrok-free.app -> http://localhost:3000
```

**免费版特点：**
- URL格式：`https://随机字符串.ngrok-free.app`
- 每次启动URL会变化（除非使用付费版固定域名）
- 有连接数限制，但足够演示使用

### 7. 配置前端连接

修改前端配置文件，将API地址改为ngrok提供的地址：

```typescript
// frontend/src/config/index.js
export default {
  baseURL: 'https://xxxx-xx-xx-xx-xx.ngrok-free.app', // 替换为你的ngrok地址
  // ...其他配置
}
```

### 8. 注意事项

- **免费版限制**：每次重启ngrok，URL会变化，需要重新配置前端
- **安全性**：ngrok会显示访问日志，注意保护敏感信息
- **稳定性**：免费版可能偶尔不稳定，但一般够用

---

## 方案二：frp（完全免费，推荐长期使用）

### 1. 使用公共frp服务器

**优点**：完全免费，无需自己搭建服务器

**步骤：**

1. **下载frp客户端**

```powershell
# Windows: 下载 frp_windows_amd64.zip
# 访问 https://github.com/fatedier/frp/releases
# 解压到任意目录，如 C:\frp
```

2. **配置frpc.ini**

```ini
[common]
server_addr = frp.freefrp.net
server_port = 7000
token = freefrp.net

[web]
type = tcp
local_ip = 127.0.0.1
local_port = 3000
remote_port = 0  # 0表示随机分配端口
```

3. **启动frp客户端**

```powershell
cd C:\frp
.\frpc.exe -c frpc.ini
```

4. **获取公网地址**

启动后会显示类似：
```
[web] start proxy success, remote port: 12345
```

公网地址：`http://frp.freefrp.net:12345`

### 2. 自建frp服务器（如果有云服务器）

如果有云服务器，可以自建frp服务器，获得固定域名。

---

## 方案三：localtunnel（最简单，但可能不稳定）

### 1. 安装

```powershell
# 使用npm全局安装
npm install -g localtunnel
```

### 2. 启动隧道

```powershell
# 暴露3000端口
lt --port 3000

# 或指定子域名（如果可用）
lt --port 3000 --subdomain yourname
```

### 3. 获取地址

启动后会显示：
```
your url is: https://yourname.loca.lt
```

**注意**：首次访问需要点击"Continue"按钮确认。

---

## 方案四：钉钉内网穿透（仅限开发测试）

### 1. 下载工具

访问：https://open.dingtalk.com/document/resourcedownload/download-intranet-penetration

下载对应系统的工具。

### 2. 配置和启动

```bash
# 解压后运行
./ding -config=./ding.cfg -subdomain=yourname 3000
```

### 3. 访问地址

```
http://yourname.vaiwan.com
```

**限制**：仅限开发测试，不能用于生产环境。

---

## 方案五：花生壳（国内服务）

### 1. 注册账号

访问：https://hsk.oray.com/

### 2. 下载客户端

下载花生壳客户端并安装。

### 3. 配置映射

1. 登录花生壳客户端
2. 添加映射：内网主机 `127.0.0.1`，内网端口 `3000`
3. 选择免费域名或使用分配的域名

### 4. 访问

使用分配的域名访问。

**免费版限制**：
- 每月1GB流量
- 带宽限制
- 域名随机

---

## 推荐配置流程（ngrok方案）

### 完整步骤

```powershell
# 1. 下载ngrok（如果还没安装）
# 访问 https://ngrok.com/download

# 2. 注册并获取token
# 访问 https://dashboard.ngrok.com/signup

# 3. 配置token
ngrok config add-authtoken YOUR_TOKEN_HERE

# 4. 启动后端服务（新开一个终端）
cd backend
npm run start:dev

# 5. 启动ngrok（新开一个终端）
ngrok http 3000

# 6. 复制ngrok提供的HTTPS地址
# 例如：https://abc123.ngrok-free.app

# 7. 修改前端配置
# 编辑 frontend/src/config/index.js
# 将 baseURL 改为 ngrok地址

# 8. 重启前端服务
cd frontend
npm run dev:h5
```

### 快速脚本（Windows PowerShell）

创建 `start-ngrok.ps1`：

```powershell
# start-ngrok.ps1
Write-Host "启动后端服务..." -ForegroundColor Green
Start-Process powershell -ArgumentList "-NoExit", "-Command", "cd backend; npm run start:dev"

Start-Sleep -Seconds 5

Write-Host "启动ngrok隧道..." -ForegroundColor Green
ngrok http 3000
```

---

## 前端配置修改

### 方式1：修改配置文件

```javascript
// frontend/src/config/index.js
export default {
  baseURL: process.env.NODE_ENV === 'production' 
    ? 'https://your-ngrok-url.ngrok-free.app'  // 生产环境使用ngrok地址
    : 'http://localhost:3000',  // 开发环境使用本地地址
  // ...
}
```

### 方式2：使用环境变量

```javascript
// frontend/src/config/index.js
export default {
  baseURL: process.env.API_BASE_URL || 'http://localhost:3000',
  // ...
}
```

然后在启动时指定：

```powershell
# Windows PowerShell
$env:API_BASE_URL="https://your-ngrok-url.ngrok-free.app"
npm run dev:h5
```

---

## 常见问题

### 1. ngrok连接失败

**问题**：`ERR_NGROK_108` 或连接超时

**解决**：
- 检查防火墙是否阻止了ngrok
- 检查网络连接
- 尝试使用 `ngrok http 3000 --region ap` 指定亚太区域

### 2. CORS跨域问题

**解决**：在后端配置CORS允许ngrok域名：

```typescript
// backend/src/main.ts
app.enableCors({
  origin: [
    'http://localhost:10086',
    'https://your-ngrok-url.ngrok-free.app',
    // 添加其他允许的域名
  ],
  credentials: true,
});
```

### 3. ngrok免费版URL变化

**问题**：每次重启ngrok，URL会变化

**解决**：
- 使用ngrok付费版固定域名
- 或使用frp自建服务器
- 或使用脚本自动更新前端配置

### 4. 访问速度慢

**原因**：免费版有带宽限制

**解决**：
- 使用付费版
- 或使用国内服务（花生壳等）

---

## 安全注意事项

1. **演示期间**：
   - 不要暴露敏感数据
   - 使用测试账号
   - 演示结束后立即关闭ngrok

2. **API安全**：
   - 确保JWT密钥足够复杂
   - 不要在生产环境使用默认密码

3. **数据库**：
   - 使用测试数据
   - 不要暴露真实数据库

---

## 演示建议

### 最佳实践

1. **准备阶段**：
   ```powershell
   # 1. 启动后端
   cd backend
   npm run start:dev
   
   # 2. 启动ngrok（新终端）
   ngrok http 3000
   
   # 3. 复制ngrok地址，修改前端配置
   # 4. 启动前端
   cd frontend
   npm run dev:h5
   ```

2. **演示时**：
   - 保持ngrok终端窗口打开
   - 确保网络连接稳定
   - 准备备用方案（如手机热点）

3. **演示后**：
   - 关闭ngrok（Ctrl+C）
   - 恢复前端配置为本地地址

---

## 快速开始（推荐ngrok）

```powershell
# 1. 安装ngrok（如果还没安装）
# 下载：https://ngrok.com/download

# 2. 注册并获取token
# 访问：https://dashboard.ngrok.com/signup

# 3. 配置token
ngrok config add-authtoken YOUR_TOKEN

# 4. 启动后端（终端1）
cd backend
npm run start:dev

# 5. 启动ngrok（终端2）
ngrok http 3000

# 6. 复制HTTPS地址，修改前端配置
# 7. 启动前端（终端3）
cd frontend
npm run dev:h5
```

**完成！** 现在可以通过ngrok提供的公网地址访问你的系统了。

---

## 其他资源

- ngrok官方文档：https://ngrok.com/docs
- frp项目地址：https://github.com/fatedier/frp
- localtunnel：https://localtunnel.github.io/www/
