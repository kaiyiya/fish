## 环境迁移与部署说明（含数据库与上传文件）

本文档说明如何将当前 AI 卖鱼小程序（后端 + 前端 + 数据库 + 上传文件）从一台电脑迁移到另一台电脑，默认使用 Docker 运行 MySQL / Redis / 后端服务。

---

### 一、旧电脑上需要做的准备

#### 1. 前提条件

- 旧电脑上项目根目录：例如 `E:\vscode\eye\eye_scan\fish`
- MySQL 使用 Docker 运行，且能在项目根目录通过 `docker-compose ps` 看到 `mysql` 容器

#### 2. 导出数据库（fish_app）

在 **项目根目录**（有 `docker-compose.yml` 的目录）打开 PowerShell，执行：

```powershell
cd E:\vscode\eye\eye_scan\fish

docker-compose ps
```

确认 `mysql` 容器是 `Up` 状态后，执行导出命令：

```powershell
cd E:\vscode\eye\eye_scan\fish

docker-compose exec mysql sh -c 'mysqldump -uroot -p$MYSQL_ROOT_PASSWORD fish_app' > backup.sql
```

说明：
- 使用的是容器内的环境变量 `MYSQL_ROOT_PASSWORD`，不需要手工输入密码。
- 命令执行成功后，项目根目录会生成一个 `backup.sql` 文件，包含 `fish_app` 库的所有结构和数据。

> 如果导出失败，可以先检查：
> - `docker-compose ps` 看 mysql 是否在运行；
> - `.env` 中的 `MYSQL_ROOT_PASSWORD` 是否为空或被改动。

#### 3. 备份上传文件

上传的图片等文件存放在后端的 `backend\uploads` 目录下，需要一并迁移。

在项目根目录 PowerShell 执行：

```powershell
cd E:\vscode\eye\eye_scan\fish

Compress-Archive -Path .\backend\uploads -DestinationPath .\uploads-backup.zip -Force
```

生成的 `uploads-backup.zip` 即为上传文件备份。

#### 4. 备份配置文件与代码

建议一并拷贝：

- **`.env` 文件**（如果存在）：包含数据库密码、JWT 密钥等关键信息；
- 整个项目目录（例如 `fish` 文件夹）。

> 最简单的做法：直接把整个 `fish` 目录拷贝到 U 盘 / 网盘，同时确保其中包含
> - `backup.sql`
> - `uploads-backup.zip`
> - `.env`

---

### 二、新电脑上的准备工作

#### 1. 安装必要软件

- 安装 **Docker Desktop for Windows**
  - 安装完成后，确认可以在 PowerShell 中执行 `docker-compose` 或 `docker compose`
- （可选）安装 **Node.js ≥ 16**，用于本地开发调试前后端

#### 2. 拷贝项目到新电脑

例如将旧电脑的项目目录拷贝到新电脑：

- 目标路径示例：`D:\projects\fish`
- 确保以下文件/目录已经存在：
  - `backend/`
  - `frontend/`
  - `docker-compose.yml`
  - `docker-compose.dev.yml`
  - `scripts/`
  - `docs/`
  - `backup.sql`
  - `uploads-backup.zip`（或 `backend\uploads`）
  - `.env`（如有）

#### 3. 检查 / 创建 `.env`

在新电脑项目根目录下：

- 如果已经从旧电脑拷贝了 `.env`，直接使用即可；
- 如果没有 `.env`，可根据 `backend/README.md` 或 `README-DOCKER.md` 中的示例创建，至少需要设置：

```text
MYSQL_ROOT_PASSWORD=rootpassword
DB_DATABASE=fish_app
DB_USERNAME=fishuser
DB_PASSWORD=fishpassword
JWT_SECRET=请换成复杂一些的随机字符串
JWT_EXPIRES_IN=7d
```

> 注意：生产环境请务必修改默认密码和 `JWT_SECRET`。

---

### 三、新电脑上恢复数据库与上传文件

#### 1. 启动 MySQL 容器

在新电脑的项目根目录 PowerShell 执行：

```powershell
cd D:\projects\fish  # 按你的实际路径修改

docker-compose up -d mysql
```

使用 `docker-compose ps` 确认 `mysql` 容器已经启动。

#### 2. 导入旧电脑导出的数据库

确保 `backup.sql` 已经位于项目根目录，然后执行：

```powershell
cd D:\projects\fish  # 按你的实际路径修改

Get-Content .\backup.sql | docker-compose exec -T mysql sh -c 'mysql -uroot -p$MYSQL_ROOT_PASSWORD fish_app'
```

说明：
- 同样使用容器内的 `MYSQL_ROOT_PASSWORD`，不需要手动输入密码。
- 如果 `fish_app` 数据库不存在，MySQL 容器启动时会根据 `scripts/init.sql` 自动创建。

导入完成后，你可以通过以下命令简单检查一下表是否存在：

```powershell
docker-compose exec mysql sh -c 'mysql -uroot -p$MYSQL_ROOT_PASSWORD -e "USE fish_app; SHOW TABLES;"'
```

#### 3. 恢复上传文件

如果你从旧电脑带来的是 `uploads-backup.zip`，在项目根目录执行：

```powershell
cd D:\projects\fish  # 按你的实际路径修改

Expand-Archive -Path .\uploads-backup.zip -DestinationPath .\backend -Force
```

执行后应当保证新电脑上的目录结构为：

- `backend\uploads\...`（包含所有历史上传图片/文件）

如果你是直接拷贝 `backend\uploads` 整个目录，只需覆盖新电脑上的同名目录即可。

---

### 四、新电脑上启动完整服务

#### 1. 使用 Docker 一键启动（适合演示 / 生产）

在项目根目录 PowerShell 执行：

```powershell
cd D:\projects\fish  # 按你的实际路径修改

.\scripts\deploy.ps1 prod
```

或直接使用 docker-compose 启动：

```powershell
cd D:\projects\fish

docker-compose up -d
```

启动成功后：

- 后端服务默认运行在：`http://localhost:3000`
- 健康检查接口：`http://localhost:3000/health`
- 如启用 Nginx profile，可通过 80 端口访问：

```powershell
docker-compose --profile nginx up -d
```

#### 2. 开发模式（Docker 只跑 MySQL / Redis）

如果在新电脑上继续开发，推荐使用开发模式：

1）启动基础服务：

```powershell
cd D:\projects\fish

docker-compose -f docker-compose.dev.yml up -d
```

2）本地启动后端：

```powershell
cd D:\projects\fish\backend

npm install
npm run start:dev
```

3）本地启动前端小程序 / H5：

```powershell
cd D:\projects\fish\frontend

npm install

# 微信小程序
npm run dev:weapp

# 或 H5
npm run dev:h5
```

---

### 五、微信小程序 / H5 侧注意事项

#### 1. 接口地址（baseURL）调整

如果前端配置中使用了固定 IP 或域名（而不是 `localhost`），在迁移到新电脑后需要：

- 根据新电脑的 IP / 域名，修改前端 `config` 中的 `baseURL`；
- 在微信小程序管理后台，将新的接口域名配置为合法请求域名。

#### 2. 微信开发者工具

在新电脑上安装微信开发者工具后：

- 导入小程序项目（使用 `frontend` 的输出目录或直接开发模式的 dist 目录）；
- 确保小程序请求的后端地址能正常访问（内网环境下注意防火墙开关和端口放行）。

---

### 六、迁移过程检查清单

**旧电脑：**

- [x] 在项目根目录执行数据库导出，生成 `backup.sql`
- [x] 压缩 `backend\uploads` 为 `uploads-backup.zip`（或直接拷贝整个目录）
- [x] 拷贝 `.env` 配置文件（如存在）
- [x] 拷贝整个项目目录（包含上述文件）

**新电脑：**

- [x] 安装 Docker Desktop，并确认 `docker-compose` 可用
- [x] 将项目目录放置到固定路径（例如 `D:\projects\fish`）
- [x] 检查或创建 `.env` 文件（数据库密码、JWT 等）
- [x] 使用 `docker-compose up -d mysql` 启动 MySQL 容器
- [x] 使用 `Get-Content backup.sql | docker-compose exec -T mysql ...` 导入数据库
- [x] 解压或拷贝 `backend\uploads` 上传目录
- [x] 使用 `.\scripts\deploy.ps1 prod` 或 `docker-compose up -d` 启动完整服务
- [x] 在浏览器 / 小程序里验证核心功能（登录、识别、下单等）是否正常

完成以上步骤后，新电脑上的环境（代码、数据库、上传文件）应与旧电脑保持一致，可以继续开发或用于演示 / 答辩。

